name: "PHPUnit Tests"

on:
  workflow_call:
    inputs:
      php-version:
        description: "PHP version to use"
        required: false
        default: "8.2"
        type: string
      coverage:
        description: "Generate code coverage?"
        required: false
        default: false
        type: boolean
      working-directory:
        description: "Directory to run tests in"
        required: false
        default: "."
        type: string
      root-directory:
        description: "Project root"
        required: false
        default: "."
        type: string

jobs:
  phpunit:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          coverage: ${{ inputs.coverage && 'xdebug' || 'none' }}

      - name: Install dependencies
        working-directory: ${{ inputs.root-directory }}
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Determine phpunit executable
        id: phpunit
        working-directory: ${{ inputs.root-directory }}
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            echo "path=$(realpath vendor/bin/phpunit)" >> "$GITHUB_OUTPUT"
          elif command -v phpunit >/dev/null 2>&1; then
            echo "path=$(command -v phpunit)" >> "$GITHUB_OUTPUT"
          else
            echo "PHPUnit not found in vendor or PATH" >&2
            exit 1
          fi   

      - name: Run PHPUnit
        run: |
          if [ "${{ inputs.coverage }}" = "true" ]; then
            "${{ steps.phpunit.outputs.path }}" --coverage-clover=coverage.xml
          else
            "${{ steps.phpunit.outputs.path }}"
          fi

      - name: Upload coverage (optional)
        if: ${{ inputs.coverage }}
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-coverage
          path: coverage.xml
